---
title: "Final to Useful Analysis"
author: "Matthew Kuperus Heun"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Final to Useful Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(dplyr)
library(IEATools)
```


## Introduction

Extended energy balance data from the 
[International Energy Agency (IEA)](https://www.iea.org)
provides both primary and final energy information.
(Primary energy is extracted from the biosphere, and 
final energy is sold to consumers.)
But consumers don't buy final energy for its own sake.
They buy final energy so they can convert it to useful energy 
(heat, light, work) that, 
when combined with infrastructure 
(buildings, roads, etc.),
provides energy services
(heated and cooled space, passenger and freight transport, etc.).

So some energy conversion chain analyses extend the final energy provided by the IEA 
to useful energy through a process that involves

(a) allocating final energy to final-to-useful energy conversion machines,
(b) defining the efficiency of those final-to-useful energy conversion machines, and
(c) calculating the useful energy injected into the the final demand economic sectors.

The `IEATools` package provides several functions to assist with the 
final-to-useful analysis process, and
this vignette demonstrates their use.


## Allocation

Extending the IEA's extended energy balance data to the useful stage begins 
with defining allocations from final energy carriers to final-to-useful energy conversion machines.
To demonstrate this process, we'll use the sample IEA data bundled with this package.

```{r}
library(dplyr)
library(IEATools)
Tidy_iea_data <- load_tidy_iea_df() %>% 
  specify_all() %>% 
  glimpse()
```

The next step is to develop a blank template for final-to-useful allocations.
`fu_allocation_template()` builds a final-to-useful allocation template
in which the analyst can provide allocation values (`C`) in percentages.

```{r}
FU_allocation_template <- load_tidy_iea_df() %>% 
  specify_all() %>%
  fu_allocation_template()
FU_allocation_template %>% 
  glimpse()
```

To obtain a nicely-formatted Excel spreadsheet, use the
`write_fu_allocation_template()` function.

```{r}
# FU_allocation_template %>% 
#   write_fu_allocation_template("~/Desktop/Test_FU_allocation_template.xlsx")
```

The analyst should complete all of the unshaded cells in the `Machine` and `Eu.product` columns.
`Machine` should contain names of final-to-useful machines such as "Automobiles," "Industrial heat/furnace," etc.
`Eu.product` should be filled with names of useful energy carriers such as "HTH.600.C", "MD", or "Light".
Note that later processing will parse the heat categories for their temperature, and the required format is `*TH.nnn.U`, where
* the first character is arbitrary, but `H`, `M`, and `L` are typical for high, medium, and low temperature heat, respectively,
* `TH.` is required,
* `nnn` can be any number of digits, optionally preceded by a negative sign, 
* `.` is required, and
* `U` is the temperature unit, one of `C`, `F`, `R`, or `K` for ° Celsius, ° Fahrenheit, rankine, or kelvin, respectively.

The `C` rows representation allocations of `E.dot` energy to final-to-useful machines for each year of available IEA data.
Three allocation rows (`C_1 [%]`, `C_2 [%]`, and `C_3 [%]`) are provided for each combination 
of `Flow.aggregation.point`, `Ef.product`, and `Destination`.
Not all `C_i [%]` rows need to be filled,
and the analyst can add more allocation rows (`C_4 [%]`, `C_5 [%]`, ...) as required.

The rows are in IEA order for `Flow.aggregation.point`, `Ef.product`, and `Destination`.

The `Maximum.values` column provides an indication of which `Destination`s receive more energy than others,
allowing the analyst to focus more attention on larger energy flows, as desired.


## Final-to-useful efficiencies

After completing the final-to-useful allocation table,
the analyst must specify the efficiencies of the final-to-useful machines.
To assist with this task, `eta_fu_template()` can be invoked.
To demonstrate, we'll use `load_fu_allocation_data()`, 
a function that reads a completed allocation table out of an excel file.
The default `path` argument of `load_fu_allocation_data()`
points to a completed final-to-useful allocation table
that is provided with `IEATools`.

```{r}
Eta_fu_template <- load_fu_allocation_data() %>% 
  eta_fu_template()
Eta_fu_template %>% 
  glimpse()
```

To obtain a nicely-formatted Excel spreadsheet, use the
`write_fu_allocation_template()` function.

```{r}
# Eta_fu_template %>% 
#  write_eta_fu_template("~/Desktop/Test_eta_fu_template.xlsx")
```

