---
title: "IEATools"
author: "Matthew Kuperus Heun"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(dplyr)
library(IEATools)
```

## Introduction

`IEATools` is an `R` package that provides functions to analyze 
extended energy balance data from the 
[International Energy Agency (IEA)](https://www.iea.org).
The IEA's data are not free. 
But if you have access to the data, you can follow the instructions in this vignette to 
analyze IEA data.


## Getting started

To get started, data must be obtained and pulled into an R data frame.

### Obtain IEA data

Purchase the IEA extended energy balances product from (http://data.iea.org).
Download the complete extended energy balance data for at least one country
in a .csv file format as shown in the following figure.

```{r, echo=FALSE, fig.cap="IEA extended energy balance data format.", out.width = '100%'}
knitr::include_graphics("figs/original_header.pdf")
```

Example data from two countries for two years are provided in the package.

```{r}
library(dplyr)
library(IEATools)
# Define the file location
IEA_path <- file.path("extdata", "GH-ZA-ktoe-Extended-Energy-Balances-sample.csv") %>% 
  system.file(package = "IEATools")
readChar(IEA_path, nchars = 256)
```


### Convert the IEA data into an R data frame

The extended energy balance data can be pulled directly into an `R` data frame 
by the `iea_df()` function. 
`iea_df()` fixes the header shown in the figure above,
conveting the header into a single row.
Furthermore, the IEA data have indicators for 
not applicable values ("`x`") and for
unavailable values ("`..`"). 
(See "World Energy Balances: Database Documentation (2018 edition)" at
(http://wds.iea.org/wds/pdf/worldbal_documentation.pdf).)

`R` has three concepts that could be used for "`x`" and "`..`":
`0` would indicate value known to be zero.
`NULL` would indicate an undefined value.
`NA` would indicate a value that is unavailable.

In theory, mapping from the IEA's indicators to `R` should proceed as follows:
"`..`" (unavailable) in the IEA data would be converted to `NA` in `R`.
"`x`" (not applicable) in the IEA data would be converted to `0` in `R`.
"`NULL`" would not be used.
However, the IEA are not consistent with their coding. 
In some places "`..`" is used for not applicable values
(e.g., World Anthracite supply in 1971). 
World Anthracite supply in 1971 is actually not applicable, because Anthracite was
classified under "Hard coal (if no detail)" in 1971.
On the other hand, "`..`" is used for data in the most recent year 
when those data have not yet been incorporated into the database. 

In the face of IEAâ€™s inconsistencies, 
the only rational way to proceed is to convert 
both "`x`" and "`..`" to "`0`".
`iea_df()` performs that task.

```{r}
IEA_data <- IEA_path %>% 
  iea_df()
IEA_data %>% 
  glimpse()
```


## Next steps

There are several reasons why the IEA extended energy balance
data are not convenient for immediate use.

1. Column titles are SHOUTING.
2. The `COUNTRY` column contains full (long) country names. 
It would be nicer if countries were identified by their [2-letter ISO codes](https://en.wikipedia.org/wiki/ISO_3166-1).
3. The demarcation between the supply and consumptions sides of the ledger is unclear to new users.
4. How data should be aggregated is unclear to new users. 
5. The data are not in [tidy format](https://doi.org/10.18637/jss.v059.i10).

The `IEATools` package has functions to address each of these issues.


### Fix column titles

To unshout the column titles, use the `rename_iea_df_cols()` function.
Column names changed by `rename_iea_df_cols()` are the defaults for arguments to other functions.

```{r}
IEA_data %>% 
  rename_iea_df_cols() %>% 
  glimpse()
```

Note that the example above uses the `rename_iea_df_cols()` function without arguments,
because the default arguments are correct for the extended energy balance data
as it arrives from the IEA.
However, both the old and new names can be specified as arguments.
If you despise both capitals letters and vowels, you could do the following.

```{r}
IEA_data %>% 
  rename_iea_df_cols(new_country = "cntry", new_flow = "flw", new_product = "prdct")  %>% 
  glimpse()
```

The default arguments are consistent throughout the `IEATools` package.
Thus, it is recommended that you use the default argument values,
wherever possible.


### Change to 2-letter ISO country abbreviations

To reduce the length of character strings representing countries, 
the `use_iso_countries()` function replaces country character strings
with each country's 2-letter abbreviation.

```{r}
IEA_data %>% 
  rename_iea_df_cols() %>% 
  use_iso_countries() %>% 
  glimpse()
```


### Remove aggregation and memo data

The IEA's extended energy balances contain many memos and aggregations in the data itself.
For the purposes of manipulations and calculations, 
it is often advisable to remove all memos and aggregations.
The `remove_agg_memo_flows()` function performs that task.

```{r}
IEA_data %>% 
  rename_iea_df_cols() %>% 
  filter(Flow == "Total primary energy supply") %>% 
  glimpse()
# Total primary energy supply is an aggregation row,
# so its rows should be absent after calling remove_agg_memo_flows().
IEA_data %>% 
  rename_iea_df_cols() %>% 
  remove_agg_memo_flows() %>% 
  filter(Flow == "Total primary energy supply")
```


### Augment with ledger side and aggregation point information

In the IEA's extended energy balance data can be confusing for first-time users to understand.
In particular, the demarcation between the supply and consumption sides of the ledger
is unclear.
And how data should be aggregated is also unclear.
To clarify these issues and make later aggregation calculations possible,
call the `augment_iea_data()` function.
`augment_iea_df()` has many default arguments that work fine for the as-delivered data.
`augment_iea_df()` adds new columns 
`Ledger.side`, `Flow.aggregation.point`, `Energy.type`, and `Unit`.

```{r}
IEA_data %>% 
  rename_iea_df_cols() %>% 
  augment_iea_df() %>% 
  glimpse()
```


### Convert to a tidy data frame

The [tidy format](https://doi.org/10.18637/jss.v059.i10) for data 
is a data frame where each datum is located on its own row.
As delivered, the IEA's data are not tidy: years are spread out as columns rather than 
being a column to themselves so that each datum occupies one row.
The `tidy_iea_df()` function converts to a tidy format.
By default, `tidy_iea_df()` removes zeroes from the data frame,
thereby reducing memory footprint.

```{r}
Tidy_IEA_df <- IEA_data %>% 
  rename_iea_df_cols() %>% 
  use_iso_countries() %>% 
  remove_agg_memo_flows() %>% 
  augment_iea_df() %>% 
  tidy_iea_df()
Tidy_IEA_df %>% 
  glimpse()
```


## The `load_tidy_iea_df()` function

For simplicity, 
all steps above are rolled into `load_tidy_iea_df()`.
By default, `load_tidy_iea_df()` 
loads the sample data bundled with the package and 
converts it to a tidy IEA data frame, 
assuming default arguments for all functions. 
But you can supply the path to any IEA data file
as an argument to `load_tidy_iea_df()`.

```{r}
simple <- load_tidy_iea_df()
complicated <- file.path("extdata", "GH-ZA-ktoe-Extended-Energy-Balances-sample.csv") %>% 
  system.file(package = "IEATools") %>% 
  iea_df() %>%
  rename_iea_df_cols() %>% 
  remove_agg_memo_flows() %>% 
  use_iso_countries() %>% 
  augment_iea_df() %>% 
  tidy_iea_df()
all(simple == complicated)
```

At this point, the integrity of the IEA data can be checked.


## Check data integrity

The IEA extended energy balance data are usually close to balanced, but not quite.
To check the integrity of the energy balances,
use the `calc_tidy_iea_df_balances()` function.
`calc_tidy_iea_df_balances()` adds several new columns to the IEA data frame,
including:

* `supply_sum` (the sum of all flows on the supply side of the ledger),
* `consumption_sum` (the sum of all flows on the consumption side of the ledger),
* `supply_minus_consumption` (the difference between supply and consumption), 
* `balance_OK` (a logical telling whether the energy balance is acceptable), and 
* `err` (supply sum when `consumption_sum` is `NA` or 
  `supply_minus_consumption` when `consumption_sum` is not `NA`).

```{r}
Balances <- Tidy_IEA_df %>% 
  calc_tidy_iea_df_balances()
Balances %>% 
  glimpse()
Balances %>% 
  tidy_iea_df_balanced()
```

Be sure to group the IEA data by appropriate variables
before calling `calc_tidy_iea_df_balances()`. 
Grouping should be done on the `Product` column
if per-product balances are desired.
Typically, grouping is also done on 
`Country`, `Year`, `Energy.type`, `Last.stage`, etc. columns.
Grouping should _not_ be done on the `Flow` column or the `Ledger.side` column.

The following code demonstrates the difference between
country-level balance calculations and product-level balance calculations.

```{r}
# Product-level balances within each country are calculated by default
Tidy_IEA_df %>% 
  calc_tidy_iea_df_balances() %>% 
  glimpse()
# Country-level balances can be calculated by setting the `grouping_vars` argument
Tidy_IEA_df %>% 
  calc_tidy_iea_df_balances(grouping_vars = c("Method", "Last.stage", "Country",
                                              "Year", "Energy.type", "Unit")) %>% 
  glimpse()
```

IEA data can be adjusted to perfect balance with the `fix_tidy_iea_df_balances()` function.

```{r}
# Fix product-level balances within each country
Tidy_IEA_df %>% 
  fix_tidy_iea_df_balances() %>% 
  calc_tidy_iea_df_balances() %>% 
  glimpse()
# Country level is also balanced
Tidy_IEA_df %>% 
  fix_tidy_iea_df_balances() %>% 
  calc_tidy_iea_df_balances(grouping_vars = c("Method", "Last.stage", "Country",
                                              "Year", "Energy.type", "Unit")) %>% 
  glimpse()
```


# Conclusion

At this point, the data have been imported to `R` and
are ready to be used for analyses. 
The next step could be to prepare for analysis with the
physical supply-use table (PSUT) framework.
See (http://prep_psut.html).


