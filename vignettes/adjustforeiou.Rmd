---
title: "Adjust EIOU Industries and Flows"
author: "Matthew Kuperus Heun"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(dplyr)
library(IEATools)
```

## Introduction

The IEA extended energy balance data include 
some `Flow`s that identify `Energy industry own use` (EIOU), 
the consumption of energy by energy-producing industries.
The list of `EIOU`-consuming industries can be found by the following code.

```{r}
library(dplyr)
library(IEATools)
EIOU_flows <- load_tidy_iea_df() %>% 
  filter(Flow.aggregation.point == "Energy industry own use")
EIOU_flows %>% 
  glimpse()
```

The list of energy-producing industries that consume energy 
can be found as shown in the following code.

```{r}
EIOU_flows %>% 
  select(Flow.aggregation.point, Flow, Product) %>% 
  unique()
```

Note that one of the industries that receives EIOU is `Coal mines`, 
but coal is not produced by `Coal mines` in the IEA data. 
Rather, coal (of various types) first appears in `Production` rows.

```{r}
load_tidy_iea_df() %>% 
  filter(Flow.aggregation.point == "Total primary energy supply", Product %in% coal_and_coal_products) %>% 
  select(Country, Flow.aggregation.point, Flow, Product) %>% 
  unique()
```

There are two problems with this approach.

* Assigning all originating flows to `Production` (as the IEA does)
  means that some EIOU is routed to an industry that does not produce anything.
  In the example above, `Electricity` is routed to `Coal mines`, but
  coal is produced by `Production`.
* Furthermore, if all primary energy carriers originate at `Production`,
  there will be problems with "upstream swims" in an Input-Output analysis:
  demand for one primary energy carrier will imply proportional demand from other primary energy carriers.
  
To solve these problems,
generic `Production` `Flow`s need to be specified.
In the example above, 
`coal_and_coal_product`s should be produced by `Coal mines`, 
not the generic `Production` industry. 
The `specify_primary_production()` function accomplishes this task.

## `specify_primary_production()`

By default, the `specify_primary_produciton()` function
performs the following actions:

* The `Production` industry for `coal_and_coal_products` 
  is replaced by `Coal mines`.
* A `Resources (Coal)` industry is created which becomes the 
  source of all primary `coal_and_coal_products` in the energy conversion chain.
* Flows from `Resources (Coal)` to `Coal mines` are added.
* The `Coal mines (energy)` EIOU `Flow` is replaced by `Coal mines`.
* The `Production` industry for `oil_and_oil_products` and `Natural gas`
  is replaced by `Oil and gas extraction`.
* A `Resources (Oil and natural gas)` industry is created which becomes the 
  source of all primary `oil_and_oil_products` and `Natural gas` in the energy conversion chain.
* Flows from `Resources (Oil and natural gas)` to `Oil and gas extraction` are added.
* The `Oil and gas extraction (energy)` EIOU `Flow` is replaced by `Oil and gas extraction`.

```{r}
Specific_primary_production <- load_tidy_iea_df() %>% 
  specify_primary_production() %>% 
  add_psut_matnames()
Specific_primary_production %>% 
  filter(Flow %in% c("Resources (Coal)", "Resources (Oil and natural gas)")) %>%
  select(-Method, -Last.stage, -Energy.type, -Ledger.side, -Unit) %>% 
  as.data.frame()
Specific_primary_production %>% 
  filter(Flow %in% c("Coal mines", "Oil and gas extraction"))
  

```


## `specify_intermediate_production()`

